window.CMB2=window.CMB2||{};window.CMB2.wysiwyg=window.CMB2.wysiwyg||{};(function(window,document,$,cmb,wysiwyg,undefined){"use strict";var toBeDestroyed=[];var toBeInitialized=[];var all=wysiwyg.all={};function delayedInit(){if(0===toBeDestroyed.length){toBeInitialized.forEach(function(toInit){toBeInitialized.splice(toBeInitialized.indexOf(toInit),1);wysiwyg.init.apply(wysiwyg,toInit)})}else{window.setTimeout(delayedInit,100)}}function delayedDestroy(){toBeDestroyed.forEach(function(id){toBeDestroyed.splice(toBeDestroyed.indexOf(id),1);wysiwyg.destroy(id)})}function getGroupData(data){var groupid=data.groupid;var fieldid=data.fieldid;if(!all[groupid]||!all[groupid][fieldid]){all[groupid]=all[groupid]||{};all[groupid][fieldid]={template:wp.template("cmb2-wysiwyg-"+groupid+"-"+fieldid),defaults:{mce:$.extend({},tinyMCEPreInit.mceInit["cmb2_i_"+groupid+fieldid]),qt:$.extend({},tinyMCEPreInit.qtInit["cmb2_i_"+groupid+fieldid])}};delete tinyMCEPreInit.mceInit["cmb2_i_"+groupid+fieldid];delete tinyMCEPreInit.qtInit["cmb2_i_"+groupid+fieldid]}return all[groupid][fieldid]}function initOptions(options){var nameRegex=new RegExp("cmb2_n_"+options.groupid+options.fieldid,"g");var idRegex=new RegExp("cmb2_i_"+options.groupid+options.fieldid,"g");var prop,newSettings,newQTS;if("undefined"===typeof tinyMCEPreInit.mceInit[options.id]){newSettings=$.extend({},options.defaults.mce);for(prop in newSettings){if("string"===typeof newSettings[prop]){newSettings[prop]=newSettings[prop].replace(idRegex,options.id).replace(nameRegex,options.name)}}tinyMCEPreInit.mceInit[options.id]=newSettings}if("undefined"===typeof tinyMCEPreInit.qtInit[options.id]){newQTS=$.extend({},options.defaults.qt);for(prop in newQTS){if("string"===typeof newQTS[prop]){newQTS[prop]=newQTS[prop].replace(idRegex,options.id).replace(nameRegex,options.name)}}tinyMCEPreInit.qtInit[options.id]=newQTS}}wysiwyg.initAll=function(){var $this,data,initiated;$(".cmb2-wysiwyg-placeholder").each(function(){$this=$(this);data=$this.data();if(data.groupid){data.id=$this.attr("id");data.name=$this.attr("name");data.value=$this.val();wysiwyg.init($this,data,false);initiated=true}});if(true===initiated){if("undefined"!==typeof window.QTags){window.QTags._buttonsInit()}$(document).on("cmb2_add_row",wysiwyg.addRow).on("cmb2_remove_group_row_start",wysiwyg.destroyRowEditors).on("cmb2_shift_rows_start",wysiwyg.shiftStart).on("cmb2_shift_rows_complete",wysiwyg.shiftComplete)}};wysiwyg.addRow=function(evt,$row){wysiwyg.initRow($row,evt)};wysiwyg.destroyRowEditors=function(evt,$btn){wysiwyg.destroy($btn.parents(".cmb-repeatable-grouping").find(".wp-editor-area").attr("id"))};wysiwyg.shiftStart=function(evt,$btn,$from,$to){$from.add($to).find(".wp-editor-wrap textarea").each(function(){wysiwyg.destroy($(this).attr("id"))})};wysiwyg.shiftComplete=function(evt,$btn,$from,$to){$from.add($to).each(function(){wysiwyg.initRow($(this),evt)})};wysiwyg.initRow=function($row,evt){var $toReplace,data,defVal;$row.find(".cmb2-wysiwyg-inner-wrap").each(function(){$toReplace=$(this);data=$toReplace.data();defVal=cmb.getFieldArg(data.hash,"default","");defVal="undefined"!==typeof defVal&&false!==defVal?defVal:"";data.iterator=$row.data("iterator");data.fieldid=data.id;data.id=data.groupid+"_"+data.iterator+"_"+data.fieldid;data.name=data.groupid+"["+data.iterator+"]["+data.fieldid+"]";data.value="cmb2_add_row"!==evt.type&&$toReplace.find(".wp-editor-area").length?$toReplace.find(".wp-editor-area").val():defVal;if(0===toBeDestroyed.length){wysiwyg.init($toReplace,data)}else{toBeInitialized.push([$toReplace,data]);window.setTimeout(delayedInit,100)}})};wysiwyg.init=function($toReplace,data,buttonsInit){if(!data.groupid){return false}var mceActive=cmb.canTinyMCE();var qtActive="function"===typeof window.quicktags;$.extend(data,getGroupData(data));initOptions(data);$toReplace.replaceWith(data.template(data));if(mceActive){window.tinyMCE.init(tinyMCEPreInit.mceInit[data.id])}if(qtActive){window.quicktags(tinyMCEPreInit.qtInit[data.id])}if(mceActive){$(document.getElementById(data.id)).parents(".wp-editor-wrap").removeClass("html-active").addClass("tmce-active")}if(false!==buttonsInit&&"undefined"!==typeof window.QTags){window.QTags._buttonsInit()}};wysiwyg.destroy=function(id){if(!cmb.canTinyMCE()){return}var editor=tinyMCE.get(id);if(editor!==null&&typeof editor!=="undefined"){editor.destroy();if("undefined"===typeof tinyMCEPreInit.mceInit[id]){delete tinyMCEPreInit.mceInit[id]}if("undefined"===typeof tinyMCEPreInit.qtInit[id]){delete tinyMCEPreInit.qtInit[id]}}else if(-1===toBeDestroyed.indexOf(id)){toBeDestroyed.push(id);window.setTimeout(delayedDestroy,100)}};$(document).on("cmb_init",wysiwyg.initAll)})(window,document,jQuery,window.CMB2,window.CMB2.wysiwyg);