window.CMB2=window.CMB2||{};window.CMB2.charcounter=window.CMB2.charcounter||{};(function(window,document,$,cmb,counter){"use strict";if(!wp.utils||!wp.utils.WordCounter){return cmb.log("Cannot find wp.utils!")}counter.counters={};var counters=counter.counters;var wpCounter=new wp.utils.WordCounter;counter.updateCounter=function(field_id){if(!counters.hasOwnProperty(field_id)){return null}var instance=counters[field_id];var wysiwyg=instance.editor&&!instance.editor.isHidden();var text=wysiwyg?instance.editor.getContent({format:"raw"}):cmb.$id(field_id).val().trim();var count=wpCounter.count(text,instance.type);var exceeded=instance.max&&count>instance.max;var val=instance.max?instance.max-count:count;instance.$el.parents(".cmb2-char-counter-wrap")[exceeded?"addClass":"removeClass"]("cmb2-max-exceeded");instance.$el.val(val).outerWidth(8*String(val).length+15+"px");return count};counter.instantiate=function($el){var data=$el.data();if(!(data.fieldId in counters)){var instance={$el:$el,max:data.max,type:"words"===data.counterType?"words":"characters_including_spaces",editor:false};counters[data.fieldId]=instance;counter.updateCounter(data.fieldId)}};counter.initAll=function(){$(".cmb2-char-counter").each(function(){counter.instantiate($(this))})};counter.initWysiwyg=function(evt,editor){if(editor.id in counters){counters[editor.id].editor=editor;editor.on("nodechange keyup",counter.countWysiwyg)}};counter.addRow=function(evt,$row){$row.find(".cmb2-char-counter").each(function(){var $this=$(this);var id=$this.attr("id");var field_id=id.replace(/^char-counter-/,"");$this.attr("data-field-id",field_id).data("field-id",field_id);counter.instantiate($this)})};counter.cleanCounters=function(){var field_id,remove=[];for(field_id in counters){if(!document.getElementById(field_id)){remove.push(field_id)}}if(remove.length){_.each(remove,function(field_id){delete counters[field_id]})}};counter.countWysiwyg=_.throttle(function(evt){if(evt.hasOwnProperty("element")){return counter.updateCounter($(evt.element).data("id"))}if(evt.hasOwnProperty("currentTarget")){return counter.updateCounter($(evt.currentTarget).data("id"))}});counter.countTextarea=_.throttle(function(evt){counter.updateCounter(evt.currentTarget.id)},400);$(document).on("cmb_init",counter.initAll).on("tinymce-editor-init",counter.initWysiwyg).on("cmb2_add_row",counter.addRow).on("cmb2_remove_row",counter.cleanCounters).on("input keyup",".cmb2-count-chars",counter.countTextarea)})(window,document,jQuery,window.CMB2,window.CMB2.charcounter);